---
title: "How is the UK healthcare system performing"
author: "Group 13: Amelia Przybyl, Athos Gyalui, Drishti Hoskote, Mingyu Dai, San Kashyap"
date: "`r Sys.Date()`"
output:
  html_document: 
    theme: sandstone
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    code_folding: hide
---

<!-- setup -->

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r, library, include = FALSE}
library(scales)
library(tidyverse) # the usual stuff: dplyr, readr, and other goodies
library(lubridate)
library(ggmap)
library(ggrepel)
library(gridExtra)
library(pander)
library(here)
library(janitor)
library(skimr)
library(leaflet)
library(leaflet.extras)
library(tmap)
library(tmaptools)
library(hrbrthemes)
library(mapview)
library(viridis)
library(plotly)
library(ggtext)
library(GGally) # for correlation-scatter plot matrix
library(treemapify)
library(RColorBrewer)
library(extrafont)
library(ggThemeAssist)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(vroom)
library(patchwork)
library(ggalt)
library(ggplot2)
library(sf)
library(stringr)
library(showtext)
```

```{r, them_function_and_palette, include = FALSE}
theme_nhs <- function() {
  font = "Avenir Next"
  theme_minimal()
  theme(
    panel.grid = element_blank(), 
    panel.background = element_blank(), 
    axis.line = element_line(size = 0.5, colour = "grey80"), 
    # Remove legend
    legend.position = "none", 
    legend.key = element_rect(fill = "transparent"), 
    axis.text.x = element_text(color = "grey20", size = 10, family = font),
    axis.text.y = element_text(color = "grey20", size = 10, family = font),
    axis.title.x = element_text(color = "grey20", size = 12, angle = 0, 
                                hjust = .5, vjust = 0, family = font),
    axis.title.y = element_text(color = "grey20", size = 12, 
                                hjust = .5, vjust = .5, family = font), 
    plot.title = element_text(color = "grey20", size = 14, 
                              family = font, face="bold"), 
    legend.text = element_text(color = "grey20", size = 10, family = font), 
    legend.title = element_text(color = "grey20", size = 12, family = font)
  )
}
palette <- c('#235eb8', '#595dac', '#756f9f', '#8a8191', '#9c9481', '#aba771', '#b9bb5e', '#c6cf45', '#d1e41a')
two_color <- c('#235eb8', '#d1e41a')
```

<!-- setup -->

# Overview of Healthcare Spending

## Healthcare spending over the years

```{r hc_spending_data, warning=FALSE, message=FALSE}

#Current health expenditure (% of GDP) (Source: https://data.worldbank.org/indicator/SH.XPD.CHEX.GD.ZS)
wb_data <- read_csv("data/healthcare-spending/world_bank_data.csv") %>%
  clean_names()

skimr::skim(wb_data)

wb_data <- wb_data %>%
  remove_empty(which=c("rows", "cols"), quiet=FALSE)

# get time series data
wb2 <- wb_data %>%
  pivot_longer(cols=c("x2000", "x2001", "x2002", "x2003", "x2004", "x2005", "x2006", "x2007", "x2008", "x2009", "x2010", "x2011", "x2012", "x2013", "x2014", "x2015", "x2016", "x2017", "x2018", "x2019"),
               names_to="Year",
               values_to="Spending") %>% 
  mutate(Year = as.integer(substr(Year, 2, 5)))
head(wb2)

```


```{r visualisations, warning=FALSE, message=FALSE}

eu <- c("AUT", "GBR", "BEL", "BGR", "CYP", "HRV", "CZE", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "HUN", "IRL", "ITA", "LVA", "LTU", "LUX", "MLT", "NLD", "POL", "PRT", "ROM", "SVK", "SVN", "ESP", "SWE")

wb2 %>%
  filter(country_code %in% eu) %>%
  mutate(is_gbr = ifelse(country_code=="GBR", 1, 0)) %>%
  group_by(is_gbr, Year) %>%
  summarize(spending_avg=mean(Spending, na.rm=TRUE)) %>%
  mutate(label = ifelse(Year != 2019, NA_character_, ifelse(is_gbr==1, "GBR", "EU"))) %>% 
  ggplot(aes(x=Year, y=spending_avg, color=as.factor(is_gbr))) + 
  geom_vline(
    xintercept = seq(1999, 2019, 1), color = "grey80", size = .4) + 
  geom_segment(
    data = tibble(y = seq(0, 11, 1), x1 = 1999, x2 = 2019),
    aes(x = x1, xend = x2, y = y, yend = y),
    inherit.aes = FALSE,
    color = "grey80",
    size = .4
  ) +
  geom_segment(
    data = tibble(y = 0, x1 = 1999, x2 = 2019),
    aes(x = x1, xend = x2, y = y, yend = y),
    inherit.aes = FALSE,
    color = "grey80",
    size = .4
  ) +
  geom_point() +
  geom_line() + 
  labs(title = "<b> UK spends relatively more on healthcare than the EU average</b><br>
       <span style = 'font-size:12pt'>Health Expenditure as % of GDP in <span style='color:#235eb8'> EU countries </span> and <span style='color:#b9bb5e'> the UK </span></span>",
       y = NULL, x = NULL, 
       caption = "Source: The World Bank (https://data.worldbank.org/indicator/SH.XPD.CHEX.GD.ZS)") + 
  theme_nhs() + 
  scale_x_continuous(breaks = seq(1999, 2019, 1), limits = c(1999, 2021), expand = c(0, 0)) + 
  scale_y_continuous(breaks = seq(0, 11, 1), labels = function(x) paste0(x, "%"), limits = c(0, 11)) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1), 
        axis.ticks = element_line(color = "grey80",),
        plot.title.position = "plot",
        plot.title = ggtext::element_textbox_simple(size=16)) + 
  geom_text_repel(
    aes(color = as.factor(is_gbr), label = label),
    xlim = c(2019, NA),
    family = "Helvetica",
    fontface = "bold",
    size = 4, 
    segment.size = .7,
    segment.alpha = .5,
    segment.linetype = "dotted"
  ) + 
  scale_color_manual(values = c(palette[1], palette[7]))

```

## San@Breaking down the cost

Analysing the NHS costs. Would be interesting to see how that has also changed over time. Creating sth like this:

![cost over time](pic_framework/cost_time.png)
- Picture Source: [https://news.sky.com/nhs-in-numbers]

- Useful resources: [https://www.england.nhs.uk/costing-in-the-nhs/national-cost-collection/]

# Workforce of Healthcare

## Athos@Healthcare workforce in the history

Employees of the health and social care systems in history: 
- History vs today 2000-2019-today
- Brexit impact - sth like below about EU workers

![labor_force1](pic_framework/labor_inflow1.jpg)
![labor_force2](pic_framework/labor_inflow2.jpg)

## Drishti@Staff Shortages


```{r}
vacancy <- read.csv("data/vacancy/vacancy_region.csv") %>% 
  clean_names() %>% 
  rename(nhscr16nm = region) %>% 
  mutate(vacancy = as.numeric(str_remove(vacancy, "%")), 
         vacancy_number = as.numeric(str_remove_all(vacancy_number, ",")))
vacancy
```


```{r, map of UK}
# make sure you have the same direcory stucture to get London wards shapefile
uk_map <- read_sf("data/vacancy/NHS_shape/NHS_Commissioning_Regions_April_2016_Generalised_Clipped_Boundaries_in_England.shp")

uk_map_wgs84 <-  uk_map %>%
  st_transform(4326)

st_geometry(uk_map_wgs84)
```

```{r}
uk_map_wgs84_with_value <- uk_map_wgs84 %>% 
  mutate(nhscr16nm = ifelse(nhscr16nm == "North Of England", "North of England", nhscr16nm)) %>%
  left_join(vacancy, by = "nhscr16nm")
```

```{r, message=FALSE, warning=FALSE}
vac_map <- uk_map_wgs84_with_value %>% 
  ggplot(aes()) +
  geom_sf(aes(fill = vacancy, text = paste(nhscr16nm, "\nVacancy rate: ", vacancy * 100, "%", sep = "")), colour = "#ffffff", size = 0.1) + 
  scale_fill_gradientn("%Vacancy", colors = c("#153A70", "#235eb8", "#296ED6", "#3082FC"), 
                       labels = c("10%", "9%", "8%", "7%"), 
                       breaks = c(0.1, 0.09, 0.08, 0.07)) + 
  theme_nhs() + 
  theme(
    legend.position = "right"
  ) + 
  labs(title = "London NHS Vacancy was above 10% \n Source: NHS Digital, 2021/22 Q4 (Mar-22)")
ggplotly(vac_map, tooltip = "text")
```


[Staff shortages in which areas](https://news.sky.com/nhs-in-numbers)

- Exploring nationalities of NHS staff (by role e.g. doctor/nurse etc)
- Exploring in which areas there are biggest staff shortages 
    - How does that correspond to the nationalities? (The biggest shortages are for nurses - where do nurses - come from currently? Are a large number of them from the EU?)
- Graph source: [https://www.bma.org.uk/advice-and-support/nhs-delivery-and-workforce/workforce/nhs-medical-staffing-data-analysis]

![staff_short](pic_framework/staff_short.png)

## How has the NHS salary changed given inflation?


```{r, Merge Average weekly earnings, warning=FALSE, message=FALSE}

# NHS Staff Earnings Estimates (Source: https://digital.nhs.uk/data-and-information/publications/statistical/nhs-staff-earnings-estimates)
nhs_salary <- read_csv("data/healthcare-spending/NHS Staff Annual Earnings Estimates to June 2022 in NHS Trusts and other core organisations in England, Provisional Statistics CSV text file.csv") %>%
  clean_names()

nhs_salary1 <- nhs_salary %>%
  filter((payment_type=="PUBGRP_020_EARNINGS") & (staff_group != "All staff")) %>%
  mutate(year = year(date)) %>%
  group_by(staff_group, year) %>%
  mutate(yearly_earnings=mean(amount)) %>%
  ggplot(aes(x=year, y=yearly_earnings, color=staff_group)) +
  geom_point() +
  geom_line() + 
  theme_nhs() + 
  theme(legend.position = "none", 
        panel.grid.major = element_line(color = "grey80"),  
        panel.grid.minor = element_line(color = "grey80"))
  
nhs_salary1 

#Average weekly earnings of people in the UK Whole Economy Level (£): Seasonally Adjusted Total Pay Excluding Arrears (Source:https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/timeseries/kab9/emp)

uk_salary <- read_csv("data/healthcare-spending/UK_salary.csv", skip=7)%>%
  clean_names() %>%
  filter(important_notes %in% c("2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")) %>%
  mutate(yearly_salary_uk=x2*52) %>%
  rename(year=important_notes) %>%
  summarize(year, yearly_salary_uk)

nhs_salary2 <- nhs_salary %>%
  filter(payment_type == "PUBGRP_020_EARNINGS",
         staff_group == "All staff") %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(yearly_earnings=sum(amount)) %>%
  filter(year != "2022") %>%
  rename(yearly_earnings_nhs=yearly_earnings)

salary_data <- merge(uk_salary, nhs_salary2, by="year")

salary_data1 <- pivot_longer(salary_data,
             cols=2:3,
             names_to="type",
             values_to="yearly_salary")
```

```{r, nhs_v_avg_plot}
salary_data1 %>%
  ggplot(aes(x=year, y=yearly_salary, color=type)) +
  geom_point() + 
  theme_nhs() + 
  theme(legend.position = "none", 
        panel.grid.major = element_line(color = "grey80"),  
        panel.grid.minor = element_line(color = "grey80"),
        plot.title.position = "plot",
        plot.title = ggtext::element_textbox_simple(size=16)) + 
  scale_color_manual(values = c(palette[1], palette[7])) +
  labs(title = "<b> NHS salaries are bad... but maybe it's just a sign of a wider problem?</b><br>
       <span style = 'font-size:12pt'> Average salary (£) over the years in the <span style='color:#235eb8'>NHS</span> compared to the <span style='color:#b9bb5e'>UK average </span></span>",
       y = NULL, x = NULL, 
       caption = "Source: ONS Whole Economy Level (£): Seasonally Adjusted Total Pay, NHS Staff Earning Estimates")

```




# Mingyu@Patient Experience


## Data cleaning

```{r, load_clean_data_wl, warning=FALSE, message=FALSE}
# load data
wl <- read.csv("data/waiting_list/nhs_waiting_list_time_series.csv")

wl_ts <-wl %>% 
  pivot_longer(-month, names_to = "indicator", values_to = "value") %>% 
  separate(indicator, c("category", "index"), "_") %>% 
  mutate(category = str_replace_all(category, "\\.", "_"), 
         index = str_replace_all(str_replace_all(index, "\\.", "_"), 
                                 "__", "_")) %>% 
  mutate(index = if_else(str_detect(index, "_$"), 
                         substr(index, 1, nchar(index) - 1), index), 
         category = if_else(str_detect(category, "_$"), 
                            substr(category, 1, nchar(category) - 1), 
                            category)) %>% 
  mutate(index = if_else(str_detect(index, "No__"), 
                         str_replace(index, "No__", "Num_more_"), 
                         str_replace(index, "No", "Num"))) %>% 
  mutate(index = if_else(str_detect(index, "^_"), 
                         str_replace(
                           str_replace(index, "_within", "perc_within"), 
                           "__", "perc_"), 
                         index)) %>% 
  mutate(month = as.Date(paste("01-", substr(month, 4, 6), 
                               "-", substr(month, 1, 2), sep=""), format = "%d-%b-%y")) %>% 
  mutate(category = as.factor(category), 
         index = as.factor(index))
# show data
head(wl_ts)
skimr::skim(wl_ts)
```

## The Expending Waiting List {.tabset .tabset-fade}

Since the pandemic, the number of patients waiting for treatment has been increasing. 

### Waiting List Expansion

The waiting list's size has accually doubled compared with that 6 years ago. 

```{r, plot_wl_incomplete_RTT, message=FALSE, warning=FALSE}
data <- wl_ts %>% 
  filter(category == "Incomplete_RTT_pathways" &
         index %in% c("Num_within_18_weeks", "Num_more_18_weeks") & 
           month >= "2012-09-01") %>% 
  group_by(month) %>% 
  summarize(total_wl = sum(value))

p_wl_incomplete_rtt <- data %>% 
  ggplot(aes(x = month, y = total_wl)) + 
  theme_nhs() + 
  theme(panel.grid.major.y = element_line(color = "grey80"), 
        panel.grid.minor.y = element_line(color = "grey80"), 
        axis.text.x = element_text(angle=45, hjust = 1, vjust = 1), 
        axis.ticks = element_line(color = "grey80")) + 
  geom_bar(stat = "identity", fill = two_color[1]) + 
  scale_y_continuous(expand = c(0, 0), 
                     labels = unit_format(unit = "million", scale = 1e-6), 
                     breaks = seq(0, 7e6, 1e6)) + 
  scale_x_date(limits = as.Date(c("2012-09-01", "2022-09-01")), 
               expand = c(0, 0), date_labels = "%b-%y", 
             breaks = date_breaks(width = "6 month")) + 
  labs(x = NULL, y = NULL, 
       title = "NHS waiting list has been increasing since the pandemic", 
       subtitle = "Sep 2012 to Sep 2022", 
       caption = "Source: Consultant-led Referral to Treatment Waiting Times Data 2022-23"
       ) + 
  geom_vline(xintercept=as.numeric(as.Date("2020-03-01")), linetype=2, col = "black") + 
  annotate("text", x = as.Date("2018-09-01"), y = 6.5*1e6, 
           label = "Start of the pandemic", hjust = 0.5, color = "black")
p_wl_incomplete_rtt
```

### Forever Waiting...

```{r, plot_wl_incomplete_RTT, message=FALSE, warning=FALSE}
data <- wl_ts %>% 
  filter(category == "Incomplete_RTT_pathways" &
         index %in% c("Num_more_18_weeks", "Num_more_52_weeks") & 
           month >= "2012-09-01") %>% 
  group_by(month, index) %>% 
  summarize(total_wl = sum(value)) %>% 
  mutate(label = ifelse(month != as.Date("2022-09-01"), NA_character_, 
                        ifelse(index == "Num_more_18_weeks", "18+ w", "52+ w")))

p_wl_18_52 <- data %>% 
  ggplot(aes(x = month, y = total_wl, fill = as.factor(index))) + 
  theme_nhs() + 
  theme(axis.line.x = element_blank(), 
        axis.text.x = element_text(angle=45, hjust = 1, vjust = 1), 
        axis.ticks = element_line(color = "grey80")) + 
  geom_segment(
    data = tibble(y = seq(0, 3200000, 400000), 
                  x1 = as.Date("2012-09-01"), 
                  x2 = as.Date("2022-09-01")),
    aes(x = x1, xend = x2, y = y, yend = y),
    inherit.aes = FALSE,
    color = "grey80",
    size = .4
  ) +
  geom_segment(
    data = tibble(y = 0, x1 = as.Date("2012-09-01"), x2 = as.Date("2022-09-01")),
    aes(x = x1, xend = x2, y = y, yend = y),
    inherit.aes = FALSE,
    color = "grey40",
    size = .4
  ) + 
  geom_area(stat = "identity", position = "identity", color = two_color[1], alpha = 0.5) + 
  scale_fill_manual(values = c("#7393E6", palette[1])) + 
  scale_y_continuous(expand = c(0, 0), breaks = seq(0, 3200000, 400000), 
                     label = comma) + 
  labs(x = NULL, y = NULL, 
       title = "Number of patients waiting over 18 and 52 weeks", 
       subtitle = "Sep 2012 to Sep 2022", 
       caption = "Source: Consultant-led Referral to Treatment Waiting Times Data 2022-23"
       ) + 
  geom_vline(xintercept=as.numeric(as.Date("2020-03-01")), linetype=2, col = "black") + 
  annotate("text", x = as.Date("2018-09-01"), y = 3000000, 
           label = "Start of the pandemic", hjust = 0.5, color = "black") + 
  scale_x_date(limits = c(as.Date("2012-09-01"), as.Date("2024-03-01")), 
               date_labels = "%y-%b", expand = c(0, 0), 
               breaks = c(as.Date("2012-09-01"), as.Date("2013-03-01"), 
                          as.Date("2013-09-01"), as.Date("2014-03-01"), 
                          as.Date("2014-09-01"), as.Date("2015-03-01"), 
                          as.Date("2015-09-01"), as.Date("2016-03-01"), 
                          as.Date("2016-09-01"), as.Date("2017-03-01"), 
                          as.Date("2017-09-01"), as.Date("2018-03-01"), 
                          as.Date("2018-09-01"), as.Date("2019-03-01"), 
                          as.Date("2019-09-01"), as.Date("2020-03-01"), 
                          as.Date("2020-09-01"), as.Date("2021-03-01"), 
                          as.Date("2021-09-01"), as.Date("2022-03-01"), as.Date("2022-09-01")
                          ))+
  geom_text_repel(
    aes(color = index, label = label),
    xlim = c(as.Date("2022-09-01"), NA),
    family = "Helvetica",
    fontface = "bold",
    size = 4, 
    segment.size = .7,
    segment.alpha = .5,
    segment.linetype = "dotted"
  ) + 
  scale_color_manual(values = c("#7393E6", palette[1]))
p_wl_18_52
```

### Percentage of forever waiting

```{r}
data
```


```{r, Percentage of forever waiting}
data <- wl_ts %>% 
  filter((category == "Incomplete_RTT_pathways") &
         (index %in% c("perc_within_18_weeks", "perc_52_weeks")) & 
           (month >= "2012-09-01")) %>% 
  group_by(month, index) %>% 
  summarize(total_wl = sum(value)) %>% 
  mutate(total_wl = ifelse(index == "perc_within_18_weeks", 1 - total_wl, total_wl), 
         index = ifelse(index == "perc_within_18_weeks", "perc_above_18_weeks", "perc_52_weeks")) %>% 
  mutate(label = ifelse(month != as.Date("2022-09-01"), NA_character_, 
                        ifelse(index == "perc_above_18_weeks", "%18+ w", "%52+ w")))

p_wl_18_52_perc <- data %>% 
  ggplot(aes(x = month, y = total_wl, fill = as.factor(index))) + 
  theme_nhs() + 
  theme(axis.line.x = element_blank(), 
        axis.text.x = element_text(angle=45, hjust = 1, vjust = 1), 
        axis.ticks = element_line(color = "grey80")) + 
  geom_segment(
    data = tibble(y = seq(0, 0.6, 0.05), 
                  x1 = as.Date("2012-09-01"), 
                  x2 = as.Date("2022-09-01")),
    aes(x = x1, xend = x2, y = y, yend = y),
    inherit.aes = FALSE,
    color = "grey80",
    size = .4
  ) +
  geom_segment(
    data = tibble(y = 0, x1 = as.Date("2012-09-01"), x2 = as.Date("2022-09-01")),
    aes(x = x1, xend = x2, y = y, yend = y),
    inherit.aes = FALSE,
    color = "grey40",
    size = .4
  ) + 
  geom_area(stat = "identity", position = "identity", color = two_color[1], alpha = 0.5) + 
  scale_fill_manual(values = c(palette[1], "#7393E6")) + 
  scale_y_continuous(labels = scales::percent, 
                     expand = c(0, 0), breaks = seq(0, 0.6, 0.05)) + 
  labs(x = NULL, y = NULL, 
       title = "Percentage of patients waiting over 18 and 52 weeks", 
       subtitle = "Sep 2012 to Sep 2022", 
       caption = "Source: Consultant-led Referral to Treatment Waiting Times Data 2022-23"
       ) + 
  geom_vline(xintercept=as.numeric(as.Date("2020-03-01")), linetype=2, col = "black") + 
  annotate("text", x = as.Date("2018-09-01"), y = 0.57, 
           label = "Start of the pandemic", hjust = 0.5, color = "black") + 
  scale_x_date(limits = c(as.Date("2012-09-01"), as.Date("2024-03-01")), 
               date_labels = "%y-%b", expand = c(0, 0), 
               breaks = c(as.Date("2012-09-01"), as.Date("2013-03-01"), 
                          as.Date("2013-09-01"), as.Date("2014-03-01"), 
                          as.Date("2014-09-01"), as.Date("2015-03-01"), 
                          as.Date("2015-09-01"), as.Date("2016-03-01"), 
                          as.Date("2016-09-01"), as.Date("2017-03-01"), 
                          as.Date("2017-09-01"), as.Date("2018-03-01"), 
                          as.Date("2018-09-01"), as.Date("2019-03-01"), 
                          as.Date("2019-09-01"), as.Date("2020-03-01"), 
                          as.Date("2020-09-01"), as.Date("2021-03-01"), 
                          as.Date("2021-09-01"), as.Date("2022-03-01"), as.Date("2022-09-01")
                          ))+
  geom_text_repel(
    aes(color = index, label = label),
    xlim = c(as.Date("2022-09-01"), NA),
    family = "Helvetica",
    fontface = "bold",
    size = 4, 
    segment.size = .7,
    segment.alpha = .5,
    segment.linetype = "dotted"
  ) + 
  scale_color_manual(values = c(palette[1], "#7393E6"))
p_wl_18_52_perc
```


# What are the good aspects of NHS? 

## Health service outcome

# Reference

<ol>

<li>[The NHS has a lot of locums. It should listen to them. ](https://www.economist.com/britain/2022/09/22/the-nhs-has-a-lot-of-locums-it-should-listen-to-them)</li>

<li>
[Health at a Glance 2021: OECD Indicators, OECD Publishing, Paris.](https://www.oecd-ilibrary.org/docserver/ae3016b9-en.pdf?expires=1668858641&id=id&accname=guest&checksum=9EED8139CB133279FCC5822C30D734C3)
</li>
[Papanicolas I, Mossialos E, Gundersen A, Woskie L, Jha A K. Performance of UK National Health Service compared with other high income countries: observational study, BMJ, 2019.](https://www.bmj.com/content/367/bmj.l6326)
<li>

</li>

<li>

</li>

</ol>
